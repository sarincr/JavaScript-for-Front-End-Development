{"version":3,"sources":["../../../../src/core-tags/core/await/renderer.js"],"names":["AsyncValue","require","safeRenderBody","renderBody","targetOut","data","err","requestData","provider","timeout","asyncValue","callback","value","length","undefined","error","errorMsg","timeoutId","setTimeout","Error","code","name","clearTimeout","LAST_OPTIONS","last","module","exports","awaitTag","input","out","clientReorder","window","isVDOM","_name","_provider","placeholderRenderer","placeholder","renderContents","asyncOut","clientReorderContext","awaitInfo","dataProvider","after","showAfter","global","instances","nextId","id","placeholderIdAttrValue","write","createOut","oldEmit","emit","event","apply","arguments","push","flush","beginAsync","beforeRenderEmitted","finished","end","asyncLastOut","onLast","oldWriter","writer","resultRenderer","then","errorRenderer","catch","renderBodyErr"],"mappings":"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","sourcesContent":["\"use strict\";\nvar complain = \"MARKO_DEBUG\" && require(\"complain\");\nvar AsyncValue = require(\"./AsyncValue\");\n\nfunction safeRenderBody(renderBody, targetOut, data) {\n  try {\n    renderBody(targetOut, data);\n  } catch (err) {\n    return err;\n  }\n}\n\nfunction requestData(provider, timeout) {\n  var asyncValue = new AsyncValue();\n\n  if (typeof provider === \"function\") {\n    // eslint-disable-next-line no-constant-condition\n    if (\"MARKO_DEBUG\") {\n      complain(\n        \"Passing a callback function to the <await> tag has been deprecated, please use a promise instead.\",\n        { level: 1, locationIndex: 3 }\n      );\n    }\n\n    var callback = function (err, data) {\n      if (err) {\n        asyncValue.___reject(err);\n      } else {\n        asyncValue.___resolve(data);\n      }\n    };\n\n    var value =\n      provider.length === 1\n        ? // one argument so only provide callback to function call\n          provider(callback)\n        : // two arguments so provide args and callback to function call\n          provider(null, callback);\n\n    if (value !== undefined) {\n      asyncValue.___resolve(value);\n    }\n  } else {\n    // Assume the provider is a data object...\n    asyncValue.___resolve(provider);\n  }\n\n  if (timeout == null) {\n    timeout = 10000;\n  }\n\n  var error;\n  var errorMsg = \"Timed out after \" + timeout + \"ms\";\n  // eslint-disable-next-line no-constant-condition\n  if (\"MARKO_DEBUG\") {\n    // Make sure we have a meaningful stack trace in development preparing the stacktrace upfront.\n    // If we create it inside the setTimeout, we will end up with a short, not meaningful, stack trace\n    // We only do it in development to avoid overhead in production\n    error = new Error(errorMsg);\n  }\n  if (timeout > 0) {\n    let timeoutId = setTimeout(function () {\n      timeoutId = null;\n      if (!error) error = new Error(errorMsg);\n      error.code = \"ERR_AWAIT_TIMEDOUT\";\n      error.name = \"TimeoutError\";\n      asyncValue.___reject(error);\n    }, timeout);\n\n    asyncValue.___done(function () {\n      if (timeoutId != null) {\n        clearTimeout(timeoutId);\n      }\n    });\n  }\n\n  return asyncValue;\n}\n\nconst LAST_OPTIONS = { last: true, name: \"await:finish\" };\n\nmodule.exports = function awaitTag(input, out) {\n  var clientReorder =\n    typeof window === \"undefined\" &&\n    input.clientReorder === true &&\n    !out.isVDOM;\n\n  var name = input.name || input._name;\n  var timeout = input.timeout;\n  var provider = input._provider;\n  var asyncValue = requestData(provider, timeout);\n  var placeholderRenderer = input.placeholder && input.placeholder.renderBody;\n\n  if (asyncValue.___settled) {\n    renderContents(asyncValue.___error, asyncValue.___value, input, out);\n    return;\n  }\n\n  var asyncOut;\n  var clientReorderContext;\n\n  var awaitInfo = {\n    name: name,\n    clientReorder: clientReorder,\n    dataProvider: provider\n  };\n\n  if (clientReorder) {\n    awaitInfo.after = input.showAfter;\n\n    clientReorderContext =\n      out.global.___clientReorderContext ||\n      (out.global.___clientReorderContext = {\n        instances: [],\n        nextId: 0\n      });\n\n    var id = (awaitInfo.id = input.name || clientReorderContext.nextId++);\n    var placeholderIdAttrValue = \"afph\" + id;\n\n    if (placeholderRenderer) {\n      out.write('<span id=\"' + placeholderIdAttrValue + '\">');\n      placeholderRenderer(out);\n      out.write(\"</span>\");\n    } else {\n      out.write('<noscript id=\"' + placeholderIdAttrValue + '\"></noscript>');\n    }\n\n    // If `client-reorder` is enabled then we asynchronously render the await instance to a new\n    // \"out\" instance so that we can Write to a temporary in-memory buffer.\n    asyncOut = awaitInfo.out = out.createOut();\n\n    var oldEmit = asyncOut.emit;\n\n    // Since we are rendering the await instance to a new and separate out,\n    // we want to proxy any child events to the main AsyncWriter in case anyone is interested\n    // in those events. This is also needed for the following events to be handled correctly:\n    //\n    // - await:begin\n    // - await:beforeRender\n    // - await:finish\n    //\n    asyncOut.emit = function (event) {\n      if (event !== \"finish\" && event !== \"error\") {\n        // We don't want to proxy the finish and error events since those are\n        // very specific to the AsyncWriter associated with the await instance\n        out.emit.apply(out, arguments);\n      }\n\n      oldEmit.apply(asyncOut, arguments);\n    };\n\n    if (clientReorderContext.instances) {\n      clientReorderContext.instances.push(awaitInfo);\n    }\n\n    out.emit(\"await:clientReorder\", awaitInfo);\n  } else {\n    out.flush(); // Flush everything up to this await instance\n    asyncOut = awaitInfo.out = out.beginAsync({\n      timeout: 0, // We will use our code for controlling timeout\n      name: name\n    });\n  }\n\n  var beforeRenderEmitted = false;\n\n  out.emit(\"await:begin\", awaitInfo);\n\n  function renderBody(err, data) {\n    if (awaitInfo.finished) {\n      return;\n    }\n\n    if (err) {\n      awaitInfo.error = err;\n    }\n\n    if (!beforeRenderEmitted) {\n      beforeRenderEmitted = true;\n      out.emit(\"await:beforeRender\", awaitInfo);\n    }\n\n    renderContents(err, data, input, asyncOut);\n\n    awaitInfo.finished = true;\n\n    if (clientReorder) {\n      asyncOut.end();\n      out.flush();\n    } else {\n      // When using client reordering we want to delay\n      // this event until after the code to move\n      // the async fragment into place has been written\n      let asyncLastOut = asyncOut.beginAsync(LAST_OPTIONS);\n      asyncOut.onLast(function () {\n        var oldWriter = asyncOut.writer;\n        // We swap out the writer so that writing will happen to our `asyncLastOut`\n        // even though we are still passing along the original `asyncOut`. We have\n        // to pass along the original `asyncOut` because that has contextual\n        // information (such as the rendered UI components)\n        asyncOut.writer = asyncLastOut.writer;\n        out.emit(\"await:finish\", awaitInfo);\n        asyncOut.writer = oldWriter;\n        asyncLastOut.end();\n        out.flush();\n      });\n\n      asyncOut.end();\n    }\n  }\n\n  asyncValue.___done(renderBody);\n};\n\nfunction renderContents(err, data, input, out) {\n  var resultRenderer = input.then && input.then.renderBody;\n  var errorRenderer = input.catch && input.catch.renderBody;\n\n  if (err) {\n    if (input.catch) {\n      if (errorRenderer) {\n        errorRenderer(out, err);\n      }\n    } else {\n      out.error(err);\n    }\n  } else {\n    if (resultRenderer) {\n      var renderBodyErr = safeRenderBody(resultRenderer, out, data);\n\n      if (renderBodyErr) {\n        return renderContents(renderBodyErr, data, input, out);\n      }\n    }\n  }\n}\n"],"file":"renderer.js"}