{"version":3,"sources":["../../../../src/core-tags/core/await/reorderer-renderer.js"],"names":["module","exports","input","out","isSync","global","__awaitReordererInvoked","flush","asyncOut","beginAsync","last","timeout","name","onLast","next","awaitContext","remaining","instances","length","end","handleAwait","awaitInfo","on","emit","bind","result","_afRuntime","script","write","id","toString","after","writer","err","error","forEach"],"mappings":"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","sourcesContent":["\"use strict\";\n\nmodule.exports = function (input, out) {\n  // We cannot call beginSync() when using renderSync(). In this case we will\n  // ignore the await-reorderer tag.\n  if (out.isSync()) {\n    return;\n  }\n\n  var global = out.global;\n\n  // We have already invoked an <await-reorderer>. We do not need to do this\n  // work again.\n  if (global.__awaitReordererInvoked) {\n    return;\n  }\n\n  global.__awaitReordererInvoked = true;\n\n  if (out.global.___clientReorderContext) {\n    out.flush();\n  }\n\n  var asyncOut = out.beginAsync({\n    last: true,\n    timeout: -1,\n    name: \"await-reorderer\"\n  });\n\n  out.onLast(function (next) {\n    var awaitContext = global.___clientReorderContext;\n    var remaining;\n\n    // Validate that we have remaining <await> instances that need handled\n    if (\n      !awaitContext ||\n      !awaitContext.instances ||\n      !(remaining = awaitContext.instances.length)\n    ) {\n      asyncOut.end();\n      next();\n      return;\n    }\n\n    function handleAwait(awaitInfo) {\n      awaitInfo.out\n        .on(\"___toString\", out.emit.bind(out, \"___toString\"))\n        .on(\"finish\", function (result) {\n          if (!global._afRuntime) {\n            // Minified version of ./client-reorder-runtime.js\n            asyncOut.script(\n              `function $af(d,a,e,l,g,h,k,b,f,c){c=$af;if(a&&!c[a])(c[a+=\"$\"]||(c[a]=[])).push(d);else{e=document;l=e.getElementById(\"af\"+d);g=e.getElementById(\"afph\"+d);h=e.createDocumentFragment();k=l.childNodes;b=0;for(f=k.length;b<f;b++)h.appendChild(k.item(0));g&&g.parentNode.replaceChild(h,g);c[d]=1;if(a=c[d+\"$\"])for(b=0,f=a.length;b<f;b++)c(a[b])}}`\n            );\n            global._afRuntime = true;\n          }\n\n          asyncOut.write(\n            '<div id=\"af' +\n              awaitInfo.id +\n              '\" style=\"display:none\">' +\n              result.toString() +\n              \"</div>\"\n          );\n\n          asyncOut.script(\n            \"$af(\" +\n              (typeof awaitInfo.id === \"number\"\n                ? awaitInfo.id\n                : '\"' + awaitInfo.id + '\"') +\n              (awaitInfo.after ? ',\"' + awaitInfo.after + '\"' : \"\") +\n              \")\"\n          );\n\n          awaitInfo.out.writer = asyncOut.writer;\n\n          out.emit(\"await:finish\", awaitInfo);\n\n          out.flush();\n\n          if (--remaining === 0) {\n            asyncOut.end();\n            next();\n          }\n        })\n        .on(\"error\", function (err) {\n          asyncOut.error(err);\n        });\n    }\n\n    awaitContext.instances.forEach(handleAwait);\n\n    out.on(\"await:clientReorder\", function (awaitInfo) {\n      remaining++;\n      handleAwait(awaitInfo);\n    });\n\n    // Now that we have a listener attached, we want to receive any additional\n    // out-of-sync instances via an event\n    delete awaitContext.instances;\n  });\n};\n"],"file":"reorderer-renderer.js"}