{"version":3,"sources":["../../../src/runtime/vdom/hot-reload.js"],"names":["runtime","require","queueMicrotask","util","registry","updateManager","createTemplate","t","createComponent","registered","queue","typeName","renderFn","template","instances","Object","defineProperty","get","proxyRenderer","set","v","length","batchUpdate","push","newProto","prototype","forEach","instance","hasLifecycleChanged","__proto__","startNode","endNode","parentNode","curNode","removeAllListeners","nextSibling","removeChild","afterInsert","apply","arguments","id","once","splice","indexOf","oldProto","hasMethodChanged","method","toString","pending","undefined","i","module","exports"],"mappings":"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","sourcesContent":["var runtime = require(\".\");\nvar queueMicrotask = require(\"../queueMicrotask\");\nvar util = require(\"../components/util\");\nvar registry = require(\"../components/registry\");\nvar updateManager = require(\"../components/update-manager\");\n\nvar createTemplate = runtime.t;\nvar createComponent = registry.___createComponent;\nvar registered = {};\nvar queue;\n\nruntime.t = function (typeName) {\n  if (registered[typeName]) {\n    return registered[typeName];\n  }\n\n  var renderFn;\n  var template = (registered[typeName] = createTemplate(typeName));\n  var instances = (template.___instances = []);\n  Object.defineProperty(template, \"_\", {\n    get: function () {\n      return renderFn && proxyRenderer;\n    },\n    set: function (v) {\n      renderFn = v;\n\n      if (instances.length) {\n        if (!queue) {\n          queue = [];\n          queueMicrotask(batchUpdate);\n        }\n\n        queue.push(function () {\n          var newProto = registry.___getComponentClass(typeName).prototype;\n          instances.forEach(function (instance) {\n            if (hasLifecycleChanged(instance.__proto__, newProto)) {\n              var startNode = instance.___rootNode.startNode;\n              var endNode = instance.___rootNode.endNode;\n              var parentNode = startNode.parentNode;\n              var curNode;\n\n              instance.___hmrDestroyed = true;\n              instance.___emitDestroy();\n              instance.___removeDOMEventListeners();\n\n              if (instance.___subscriptions) {\n                instance.___subscriptions.removeAllListeners();\n                instance.___subscriptions = null;\n              }\n\n              while ((curNode = startNode.nextSibling) !== endNode) {\n                util.___destroyNodeRecursive(curNode);\n                parentNode.removeChild(curNode);\n              }\n\n              instance.___hmrDestroyed = false;\n              instance.___mounted = false;\n            }\n\n            instance.__proto__ = newProto;\n            instance\n              .___rerender(instance.___input, false)\n              .afterInsert(instance.___document);\n          });\n        });\n      }\n    }\n  });\n\n  return template;\n\n  function proxyRenderer() {\n    return renderFn.apply(this, arguments);\n  }\n};\n\nregistry.___createComponent = function (typeName, id) {\n  var template = registered[typeName];\n  var instance = createComponent(typeName, id);\n\n  if (template) {\n    var instances = template.___instances;\n    instances.push(instance);\n    instance.once(\"destroy\", function () {\n      if (!instance.___hmrDestroyed) {\n        instances.splice(1, instances.indexOf(instance));\n      }\n    });\n  }\n\n  return instance;\n};\n\nfunction hasLifecycleChanged(oldProto, newProto) {\n  return (\n    hasMethodChanged(\"onCreate\") ||\n    hasMethodChanged(\"onInput\") ||\n    hasMethodChanged(\"onRender\") ||\n    hasMethodChanged(\"onMount\")\n  );\n\n  function hasMethodChanged(method) {\n    return (\n      (oldProto[method] && oldProto[method].toString()) !==\n      (newProto[method] && newProto[method].toString())\n    );\n  }\n}\n\nfunction batchUpdate() {\n  updateManager.___batchUpdate(function () {\n    var pending = queue;\n    queue = undefined;\n\n    for (var i = 0; i < pending.length; i++) {\n      pending[i]();\n    }\n  });\n}\n\nmodule.exports = runtime;\n"],"file":"hot-reload.js"}