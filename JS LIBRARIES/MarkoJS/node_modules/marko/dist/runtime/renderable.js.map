{"version":3,"sources":["../../src/runtime/renderable.js"],"names":["defaultCreateOut","require","setImmediate","extend","safeRender","renderFunc","finalData","finalOut","shouldEnd","end","err","actualEnd","error","module","exports","target","renderer","render","createOut","renderToString","data","callback","localData","_","globalData","$global","out","global","template","undefined","on","toString","once","sync","renderSync","shouldBuffer"],"mappings":"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","sourcesContent":["var defaultCreateOut = require(\"./createOut\");\nvar setImmediate = require(\"./setImmediate\");\nvar extend = require(\"raptor-util/extend\");\n\nfunction safeRender(renderFunc, finalData, finalOut, shouldEnd) {\n  try {\n    renderFunc(finalData, finalOut);\n\n    if (shouldEnd) {\n      finalOut.end();\n    }\n  } catch (err) {\n    var actualEnd = finalOut.end;\n    finalOut.end = function () {};\n\n    setImmediate(function () {\n      finalOut.end = actualEnd;\n      finalOut.error(err);\n    });\n  }\n  return finalOut;\n}\n\nmodule.exports = function (target, renderer) {\n  var renderFunc =\n    renderer && (renderer.renderer || renderer.render || renderer);\n  var createOut = target.createOut || renderer.createOut || defaultCreateOut;\n\n  return extend(target, {\n    createOut: createOut,\n\n    renderToString: function (data, callback) {\n      var localData = data || {};\n      var render = renderFunc || this._;\n      var globalData = localData.$global;\n      var out = createOut(globalData);\n\n      out.global.template = this;\n\n      if (globalData) {\n        localData.$global = undefined;\n      }\n\n      if (callback) {\n        out\n          .on(\"finish\", function () {\n            callback(null, out.toString(), out);\n          })\n          .once(\"error\", callback);\n\n        return safeRender(render, localData, out, true);\n      } else {\n        out.sync();\n        render(localData, out);\n        return out.toString();\n      }\n    },\n\n    renderSync: function (data) {\n      var localData = data || {};\n      var render = renderFunc || this._;\n      var globalData = localData.$global;\n      var out = createOut(globalData);\n      out.sync();\n\n      out.global.template = this;\n\n      if (globalData) {\n        localData.$global = undefined;\n      }\n\n      render(localData, out);\n      return out.___getResult();\n    },\n\n    /**\n     * Renders a template to either a stream (if the last\n     * argument is a Stream instance) or\n     * provides the output to a callback function (if the last\n     * argument is a Function).\n     *\n     * Supported signatures:\n     *\n     * render(data)\n     * render(data, out)\n     * render(data, stream)\n     * render(data, callback)\n     *\n     * @param  {Object} data The view model data for the template\n     * @param  {AsyncStream/AsyncVDOMBuilder} out A Stream, an AsyncStream/AsyncVDOMBuilder instance, or a callback function\n     * @return {AsyncStream/AsyncVDOMBuilder} Returns the AsyncStream/AsyncVDOMBuilder instance that the template is rendered to\n     */\n    render: function (data, out) {\n      var callback;\n      var finalOut;\n      var finalData;\n      var globalData;\n      var render = renderFunc || this._;\n      var shouldBuffer = this.___shouldBuffer;\n      var shouldEnd = true;\n\n      if (data) {\n        finalData = data;\n        if ((globalData = data.$global)) {\n          finalData.$global = undefined;\n        }\n      } else {\n        finalData = {};\n      }\n\n      if (out && out.___isOut) {\n        finalOut = out;\n        shouldEnd = false;\n        extend(out.global, globalData);\n      } else if (typeof out == \"function\") {\n        finalOut = createOut(globalData);\n        callback = out;\n      } else {\n        finalOut = createOut(\n          globalData, // global\n          out, // writer(AsyncStream) or parentNode(AsyncVDOMBuilder)\n          undefined, // parentOut\n          shouldBuffer // ignored by AsyncVDOMBuilder\n        );\n      }\n\n      if (callback) {\n        finalOut\n          .on(\"finish\", function () {\n            callback(null, finalOut.___getResult());\n          })\n          .once(\"error\", callback);\n      }\n\n      globalData = finalOut.global;\n\n      globalData.template = globalData.template || this;\n\n      return safeRender(render, finalData, finalOut, shouldEnd);\n    }\n  });\n};\n"],"file":"renderable.js"}