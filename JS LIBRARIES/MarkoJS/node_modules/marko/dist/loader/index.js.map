{"version":3,"sources":["../../src/loader/index.js"],"names":["nodePath","require","fs","Module","markoCompiler","cwd","process","fsOptions","encoding","requiredCompilerOptions","modules","module","exports","load","templatePath","templateSrc","options","arguments","length","doLoad","lastArg","finalOptions","Error","loadSource","compiledSrc","cached","cache","templateModule","paths","_nodeModulePaths","dirname","filename","_cache","_compile","getCachedTemplate","precompiledTemplatePath","existsSync","Object","assign","defaultOptions","resolve","template","readFileSync","compile","default"],"mappings":"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","sourcesContent":["\"use strict\";\nvar nodePath = require(\"path\");\nvar fs = require(\"fs\");\nvar Module = require(\"module\").Module;\nvar markoCompiler = require(\"../compiler\");\nvar cwd = process.cwd();\nvar fsOptions = { encoding: \"utf8\" };\nvar requiredCompilerOptions = { modules: \"cjs\" };\n\nmodule.exports = function load(templatePath, templateSrc, options) {\n  if (arguments.length === 1) {\n    return doLoad(templatePath);\n  } else if (arguments.length === 2) {\n    // see if second argument is templateSrc (a String)\n    // or options (an Object)\n    var lastArg = arguments[arguments.length - 1];\n    if (typeof lastArg === \"string\") {\n      return doLoad(templatePath, templateSrc);\n    } else {\n      var finalOptions = templateSrc;\n      return doLoad(templatePath, null, finalOptions);\n    }\n  } else if (arguments.length === 3) {\n    // assume function called according to function signature\n    return doLoad(templatePath, templateSrc, options);\n  } else {\n    throw new Error(\"Illegal arguments\");\n  }\n};\n\nfunction loadSource(templatePath, compiledSrc) {\n  // Short-circuit loading if the template has already been cached in the Node.js require cache\n  var cached = require.cache[templatePath];\n  if (cached) {\n    return cached.exports;\n  }\n\n  var templateModule = new Module(templatePath, module);\n  templateModule.paths = Module._nodeModulePaths(\n    nodePath.dirname(templatePath)\n  );\n  templateModule.filename = templatePath;\n\n  Module._cache[templatePath] = templateModule;\n\n  templateModule._compile(compiledSrc, templatePath);\n\n  return templateModule.exports;\n}\n\nfunction getCachedTemplate(templatePath) {\n  var precompiledTemplatePath = templatePath + \".js\";\n  var templateModule =\n    require.cache[templatePath] || require.cache[precompiledTemplatePath];\n\n  if (templateModule) {\n    return templateModule.exports;\n  } else if (fs.existsSync(precompiledTemplatePath)) {\n    return require(precompiledTemplatePath);\n  }\n}\n\nfunction doLoad(templatePath, templateSrc, options) {\n  options = Object.assign(\n    {},\n    markoCompiler.defaultOptions,\n    options,\n    requiredCompilerOptions\n  );\n  templatePath = nodePath.resolve(cwd, templatePath);\n  var template = getCachedTemplate(templatePath);\n\n  if (!template) {\n    if (templateSrc == null) {\n      templateSrc = fs.readFileSync(templatePath, fsOptions);\n    }\n\n    var compiledSrc = markoCompiler.compile(templateSrc, templatePath, options);\n\n    template = loadSource(templatePath, compiledSrc);\n  }\n\n  if (template.default) {\n    template = template.default;\n  }\n\n  return template;\n}\n"],"file":"index.js"}