{"version":3,"sources":["../../../src/tag/native-tag[vdom]/index.js"],"names":["SIMPLE_ATTRS","MAYBE_SVG","a","script","style","title","tagArguments","path","isStatic","hub","file","node","parent","name","key","body","handlers","tagProperties","extra","properties","runtimeFlags","get","forEach","attr","confident","computed","remove","set","t","stringLiteral","attrsObj","isNullLiteral","isObjectExpression","some","isSpreadElement","FLAGS","SPREAD_ATTRS","callExpression","writeArgs","nullLiteral","_componentInstanceIdentifier","numericLiteral","length","preserveAttrs","push","objectProperty","identifier","arrayExpression","map","Object","entries","eventName","arguments","args","once","delegateArgs","booleanLiteral","slice","memberExpression","_componentDefIdentifier","every","n","isPropertyName","HAS_SIMPLE_ATTRS","tagDef","htmlType","IS_CUSTOM_ELEMENT","isMarkoTag","IS_SVG","IS_TEXTAREA","objectExpression","isNullable","isEmpty","writeStartNode","ifStatement","expressionStatement","replaceWith","writeEndNode","needsBlock","childNode","isVariableDeclaration","kind","replaceWithMultiple","concat","blockStatement","names","isStringLiteral","includes","value","isIdentifier"],"mappings":"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","sourcesContent":["import { types as t } from \"@marko/compiler\";\nimport write from \"../../util/vdom-out-write\";\nimport * as FLAGS from \"../../util/runtime-flags\";\nimport { getAttrs, evaluateAttr } from \"../util\";\nimport {\n  getTagDef,\n  normalizeTemplateString,\n  importDefault\n} from \"@marko/babel-utils\";\nimport withPreviousLocation from \"../../util/with-previous-location\";\n\nconst SIMPLE_ATTRS = [\"id\", \"class\", \"style\"];\nconst MAYBE_SVG = {\n  a: true,\n  script: true,\n  style: true,\n  title: true\n};\n\nexport function tagArguments(path, isStatic) {\n  const {\n    hub: { file },\n    node,\n    parent\n  } = path;\n  const {\n    name,\n    key,\n    body: { body },\n    handlers\n  } = node;\n  const tagProperties = (path.node.extra && path.node.extra.properties) || [];\n  let runtimeFlags = 0;\n\n  path.get(\"attributes\").forEach(attr => {\n    const { confident, computed } = evaluateAttr(attr);\n\n    if (confident) {\n      if (computed == null || computed === false) {\n        attr.remove();\n      } else {\n        attr.set(\"value\", t.stringLiteral(computed));\n      }\n    }\n  });\n\n  let attrsObj = getAttrs(path, true, true);\n\n  if (!t.isNullLiteral(attrsObj)) {\n    if (\n      !t.isObjectExpression(attrsObj) ||\n      attrsObj.properties.some(t.isSpreadElement)\n    ) {\n      runtimeFlags |= FLAGS.SPREAD_ATTRS;\n      attrsObj = t.callExpression(\n        importDefault(\n          file,\n          \"marko/src/runtime/vdom/helpers/attrs\",\n          \"marko_attrs\"\n        ),\n        [attrsObj]\n      );\n    }\n  }\n\n  const writeArgs = [\n    name,\n    attrsObj,\n    !key && isStatic ? t.nullLiteral() : key,\n    isStatic ? t.nullLiteral() : file._componentInstanceIdentifier,\n    isStatic\n      ? t.numericLiteral(body.length)\n      : body.length\n      ? t.nullLiteral()\n      : t.numericLiteral(0)\n  ];\n\n  if (node.preserveAttrs) {\n    tagProperties.push(\n      t.objectProperty(\n        t.identifier(\"pa\"),\n        t.arrayExpression(node.preserveAttrs.map(name => t.stringLiteral(name)))\n      )\n    );\n  }\n\n  if (handlers) {\n    Object.entries(handlers).forEach(\n      ([eventName, { arguments: args, once }]) => {\n        const delegateArgs = [t.stringLiteral(eventName), args[0]];\n\n        // TODO: look into only sending this if once is true.\n        delegateArgs.push(t.booleanLiteral(once));\n\n        if (args.length > 1) {\n          delegateArgs.push(t.arrayExpression(args.slice(1)));\n        }\n\n        // TODO: why do we output eventName twice.\n        tagProperties.push(\n          t.objectProperty(\n            t.stringLiteral(`on${eventName}`),\n            t.callExpression(\n              t.memberExpression(\n                file._componentDefIdentifier,\n                t.identifier(\"d\")\n              ),\n              delegateArgs\n            )\n          )\n        );\n      }\n    );\n  }\n\n  if (\n    t.isObjectExpression(attrsObj) &&\n    attrsObj.properties.every(n => isPropertyName(n, SIMPLE_ATTRS)) &&\n    !node.preserveAttrs\n  ) {\n    runtimeFlags |= FLAGS.HAS_SIMPLE_ATTRS;\n  }\n\n  const tagDef = getTagDef(path);\n\n  if (tagDef) {\n    const { htmlType, name } = tagDef;\n    if (htmlType === \"custom-element\") {\n      runtimeFlags |= FLAGS.IS_CUSTOM_ELEMENT;\n    } else if (\n      htmlType === \"svg\" ||\n      (MAYBE_SVG[name] &&\n        t.isMarkoTag(parent) &&\n        parent.tagDef &&\n        parent.tagDef.htmlType === \"svg\")\n    ) {\n      runtimeFlags |= FLAGS.IS_SVG;\n    } else if (name === \"textarea\") {\n      runtimeFlags |= FLAGS.IS_TEXTAREA;\n    }\n  }\n\n  writeArgs.push(t.numericLiteral(runtimeFlags));\n\n  if (tagProperties.length) {\n    writeArgs.push(t.objectExpression(tagProperties));\n  }\n  return writeArgs;\n}\n\n/**\n * Translates the html streaming version of a standard html element.\n */\nexport default function (path, isNullable) {\n  const { node } = path;\n  const {\n    name,\n    key,\n    body: { body }\n  } = node;\n\n  const isEmpty = !body.length;\n  const writeArgs = tagArguments(path, false);\n  let writeStartNode = withPreviousLocation(\n    write(isEmpty ? \"e\" : \"be\", ...writeArgs),\n    node.name\n  );\n\n  if (isNullable) {\n    writeStartNode = t.ifStatement(\n      name,\n      writeStartNode,\n      t.expressionStatement(\n        t.callExpression(\n          t.memberExpression(t.identifier(\"out\"), t.identifier(\"bf\")),\n          [\n            normalizeTemplateString`f_${key}`,\n            path.hub.file._componentInstanceIdentifier\n          ]\n        )\n      )\n    );\n  }\n\n  if (isEmpty) {\n    path.replaceWith(writeStartNode);\n    return;\n  }\n\n  let writeEndNode = write(\"ee\");\n  if (isNullable) {\n    writeEndNode = t.ifStatement(\n      name,\n      writeEndNode,\n      t.expressionStatement(\n        t.callExpression(\n          t.memberExpression(t.identifier(\"out\"), t.identifier(\"ef\")),\n          []\n        )\n      )\n    );\n  }\n\n  let needsBlock;\n  for (const childNode of body) {\n    if (t.isVariableDeclaration(childNode)) {\n      if (childNode.kind === \"const\" || childNode.kind === \"let\") {\n        needsBlock = true;\n        break;\n      }\n    }\n  }\n\n  path.replaceWithMultiple(\n    [writeStartNode]\n      .concat(needsBlock ? t.blockStatement(body) : body)\n      .concat(writeEndNode)\n  );\n}\n\nfunction isPropertyName({ key }, names) {\n  if (t.isStringLiteral(key)) {\n    return names.includes(key.value);\n  } else if (t.isIdentifier(key)) {\n    return names.includes(key.name);\n  }\n}\n"],"file":"index.js"}