{"version":3,"sources":["../../src/util/optimize-vdom-create.js"],"names":["staticNodes","WeakSet","mergeStaticCreateVisitor","MarkoText","path","state","node","currentRoot","t","callExpression","memberExpression","identifier","stringLiteral","value","MarkoPlaceholder","get","evaluate","toString","MarkoTag","attributes","find","a","name","resolveKey","writeArgs","analyzeStaticVisitor","add","escape","confident","enter","skip","exit","isStatic","body","params","length","arguments","tagDef","translator","every","attr","isMarkoAttribute","modifier","directives","attrValue","exclude","isObjectExpression","isArrayExpression","isRegExpLiteral","has","optimizeStaticVDOM","hub","file","shouldRun","markoOpts","parentPath","scope","generateUidIdentifier","traverse","d","variableDeclaration","variableDeclarator","push","replaceWith","_componentInstanceIdentifier","analyzeStaticVDOM","optimize","output"],"mappings":"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","sourcesContent":["import { decode } from \"he\";\nimport { types as t } from \"@marko/compiler\";\nimport {\n  importDefault,\n  isNativeTag,\n  isLoopTag,\n  getTagDef\n} from \"@marko/babel-utils\";\nimport { getKeyManager } from \"./key-manager\";\nimport write from \"./vdom-out-write\";\nimport { tagArguments } from \"../tag/native-tag[vdom]\";\nimport directives from \"../tag/attribute/directives\";\n\nconst staticNodes = new WeakSet();\n\nconst mergeStaticCreateVisitor = {\n  MarkoText(path, state) {\n    const { node } = path;\n    state.currentRoot = t.callExpression(\n      t.memberExpression(state.currentRoot, t.identifier(\"t\")),\n      [t.stringLiteral(decode(node.value))]\n    );\n  },\n  MarkoPlaceholder(path, state) {\n    const { value } = path.get(\"value\").evaluate();\n    state.currentRoot = t.callExpression(\n      t.memberExpression(state.currentRoot, t.identifier(\"t\")),\n      [t.stringLiteral(value != null ? value.toString() : \"\")]\n    );\n  },\n  MarkoTag(path, state) {\n    if (path.node.attributes.find(a => a.name === \"key\"))\n      getKeyManager(path).resolveKey(path);\n    const writeArgs = tagArguments(path, true);\n    state.currentRoot = t.callExpression(\n      t.memberExpression(state.currentRoot, t.identifier(\"e\")),\n      writeArgs\n    );\n  }\n};\n\nconst analyzeStaticVisitor = {\n  MarkoText(path) {\n    staticNodes.add(path.node);\n  },\n  MarkoPlaceholder(path) {\n    if (path.node.escape) {\n      const { confident } = path.get(\"value\").evaluate();\n      if (confident) {\n        staticNodes.add(path.node);\n      }\n    }\n  },\n  MarkoTag: {\n    enter(path) {\n      // needed to handle global keys on elements that don't have specific key attributes\n      if (isLoopTag(path)) path.skip();\n    },\n    exit(path) {\n      // check name\n      let isStatic =\n        isNativeTag(path) &&\n        !path.node.body.params.length &&\n        !path.node.arguments;\n\n      const tagDef = getTagDef(path);\n      isStatic = isStatic && !tagDef.translator;\n\n      // check attributes\n      isStatic =\n        isStatic &&\n        path.get(\"attributes\").every(attr => {\n          if (\n            !t.isMarkoAttribute(attr) ||\n            attr.node.arguments ||\n            attr.node.modifier ||\n            directives[attr.node.name]\n          )\n            return false;\n\n          const attrValue = attr.get(\"value\");\n          const exclude =\n            t.isObjectExpression(attrValue) ||\n            t.isArrayExpression(attrValue) ||\n            t.isRegExpLiteral(attrValue);\n          if (exclude) return false;\n          const { confident } = attrValue.evaluate();\n          return confident;\n        });\n\n      // check children\n      isStatic =\n        isStatic &&\n        path\n          .get(\"body\")\n          .get(\"body\")\n          .every(t => staticNodes.has(t.node));\n\n      if (isStatic) staticNodes.add(path.node);\n    }\n  }\n};\n\nexport function optimizeStaticVDOM(path) {\n  const {\n    hub: { file }\n  } = path;\n\n  if (\n    !shouldRun(file.markoOpts) ||\n    !staticNodes.has(path.node) ||\n    staticNodes.has(path.parentPath.parentPath.node)\n  ) {\n    return;\n  }\n\n  const identifier = path.scope.generateUidIdentifier(\"marko_node\");\n  const writeArgs = tagArguments(path, true);\n  const state = {\n    currentRoot: t.callExpression(\n      importDefault(\n        file,\n        \"marko/src/runtime/vdom/helpers/v-element\",\n        \"marko_createElement\"\n      ),\n      writeArgs\n    )\n  };\n\n  path.traverse(mergeStaticCreateVisitor, state);\n\n  const d = t.variableDeclaration(\"const\", [\n    t.variableDeclarator(identifier, state.currentRoot)\n  ]);\n  file.path.node.body.push(d);\n  path.replaceWith(write(\"n\", identifier, file._componentInstanceIdentifier));\n  path.skip();\n}\n\nexport function analyzeStaticVDOM(path) {\n  if (shouldRun(path.hub.file.markoOpts)) {\n    path.traverse(analyzeStaticVisitor);\n  }\n}\n\nfunction shouldRun(markoOpts) {\n  return markoOpts.optimize && markoOpts.output !== \"html\";\n}\n"],"file":"optimize-vdom-create.js"}