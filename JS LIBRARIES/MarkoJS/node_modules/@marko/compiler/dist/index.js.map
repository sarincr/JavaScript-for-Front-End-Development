{"version":3,"sources":["../src/index.js"],"names":["globalConfig","defaultConfig","configure","newConfig","compile","src","filename","config","babelConfig","loadBabelConfig","babelResult","babel","transformAsync","scheduleDefaultClear","buildResult","compileSync","transformSync","compileFile","Promise","resolve","reject","getFs","readFile","err","compileFileSync","readFileSync","getRuntimeEntryFiles","output","requestedTranslator","translator","markoConfig","undefined","requiredPlugins","corePlugin","baseBabelConfig","filenameRelative","path","relative","process","cwd","sourceFileName","basename","sourceType","sourceMaps","code","ast","modules","push","require","loose","plugins","concat","loadPartialConfig","options","map","metadata","marko","meta","scheduledClear","clearingDefaultFs","clearingDefaultCache","isDefaultCache","isDefaultFS","setImmediate","_clearDefaults","cache","clear","fileSystem","purge"],"mappings":"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","sourcesContent":["export * as types from \"./babel-types\";\nimport path from \"path\";\nimport * as babel from \"@babel/core\";\nimport corePlugin from \"./babel-plugin\";\nimport defaultConfig from \"./config\";\nimport * as taglib from \"./taglib\";\nimport shouldOptimize from \"./util/should-optimize\";\nimport tryLoadTranslator from \"./util/try-load-translator\";\nexport { taglib };\n\nlet globalConfig = { ...defaultConfig };\nexport function configure(newConfig) {\n  globalConfig = { ...defaultConfig, ...newConfig };\n}\n\nexport async function compile(src, filename, config) {\n  const babelConfig = loadBabelConfig(filename, config);\n  const babelResult = await babel.transformAsync(src, babelConfig);\n  scheduleDefaultClear(config);\n  return buildResult(babelResult);\n}\n\nexport function compileSync(src, filename, config) {\n  const babelConfig = loadBabelConfig(filename, config);\n  const babelResult = babel.transformSync(src, babelConfig);\n  scheduleDefaultClear(config);\n  return buildResult(babelResult);\n}\n\nexport async function compileFile(filename, config) {\n  return new Promise((resolve, reject) => {\n    getFs(config).readFile(filename, \"utf-8\", (err, src) => {\n      if (err) {\n        return reject(err);\n      }\n\n      return resolve(compile(src, filename, config));\n    });\n  });\n}\n\nexport function compileFileSync(filename, config) {\n  const src = getFs(config).readFileSync(filename, \"utf-8\");\n  return compileSync(src, filename, config);\n}\n\nexport function getRuntimeEntryFiles(output, requestedTranslator) {\n  const translator = tryLoadTranslator(requestedTranslator);\n  if (translator && translator.getRuntimeEntryFiles) {\n    return translator.getRuntimeEntryFiles(output, shouldOptimize());\n  }\n\n  return [];\n}\n\nfunction loadBabelConfig(filename, config) {\n  const markoConfig = { ...globalConfig, ...config, babelConfig: undefined };\n  const requiredPlugins = [[corePlugin, markoConfig]];\n  const baseBabelConfig = {\n    filenameRelative: filename\n      ? path.relative(process.cwd(), filename)\n      : undefined,\n    sourceFileName: filename ? path.basename(filename) : undefined,\n    ...(config && config.babelConfig),\n    filename,\n    sourceType: \"module\",\n    sourceMaps: markoConfig.sourceMaps,\n    code: markoConfig.code,\n    ast: markoConfig.ast\n  };\n\n  if (markoConfig.modules === \"cjs\") {\n    requiredPlugins.push([\n      require.resolve(\"@babel/plugin-transform-modules-commonjs\"),\n      { loose: true }\n    ]);\n  }\n\n  baseBabelConfig.plugins = requiredPlugins.concat(\n    baseBabelConfig.plugins || []\n  );\n\n  return babel.loadPartialConfig(baseBabelConfig).options;\n}\n\nfunction buildResult(babelResult) {\n  const {\n    ast,\n    map,\n    code,\n    metadata: { marko: meta }\n  } = babelResult;\n  return { ast, map, code, meta };\n}\n\nlet scheduledClear = false;\nlet clearingDefaultFs = false;\nlet clearingDefaultCache = false;\nfunction scheduleDefaultClear(config) {\n  if (!scheduledClear) {\n    clearingDefaultCache = isDefaultCache(config);\n    clearingDefaultFs = isDefaultFS(config);\n\n    if (clearingDefaultCache || clearingDefaultFs) {\n      scheduledClear = true;\n      setImmediate(_clearDefaults);\n    }\n  }\n}\n\nexport function _clearDefaults() {\n  if (clearingDefaultCache) {\n    clearingDefaultCache = false;\n    globalConfig.cache.clear();\n  }\n\n  if (clearingDefaultFs) {\n    clearingDefaultFs = false;\n    globalConfig.fileSystem.purge();\n  }\n  scheduledClear = false;\n}\n\nfunction isDefaultCache(config) {\n  return !config.cache || config.cache === globalConfig.cache;\n}\n\nfunction isDefaultFS(config) {\n  return getFs(config) === globalConfig.fileSystem;\n}\n\nfunction getFs(config) {\n  return config.fileSystem || globalConfig.fileSystem;\n}\n"],"file":"index.js"}