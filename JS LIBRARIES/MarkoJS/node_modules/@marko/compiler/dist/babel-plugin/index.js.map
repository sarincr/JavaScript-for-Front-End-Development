{"version":3,"sources":["../../src/babel-plugin/index.js"],"names":["SOURCE_FILES","WeakMap","api","markoOpts","assertVersion","translator","output","optimize","undefined","cache","using","shouldOptimize","translate","Error","resolveVirtualDependency","curOpts","name","manipulateOptions","opts","parserOverride","code","prevFS","curFS","fileSystem","file","getMarkoFile","finalAst","t","cloneNode","ast","set","pre","metadata","sourceFile","get","taglibLookup","___taglibLookup","rootTranslators","buildCodeFrameError","buildError","hub","marko","shallowClone","MarkoFile","prototype","bind","___getMarkoFile","id","taglibsById","addPlugin","push","traverseAll","watchFiles","filter","unique","fileOpts","compileCache","Map","filename","isSource","isMigrate","canCache","contentHash","update","digest","cacheKey","cached","watchFile","mtime","Infinity","statSync","time","path","dirname","type","program","sourceType","body","directives","meta","macros","deps","tags","start","end","length","loc","line","column","scope","crawl","rootMigrators","migrator","migrators","migrate","rootTransformers","transformer","transformers","transform","taglibId","filePath","endsWith","analyze","Date","now","data","clone","key","v","Ctor","constructor","Array","Object","Set","RegExp","mergeVisitors","all","isArray","visitors","merge","explode","Program","mergedVisitors","state","enter","_call","traverse","exit","arr","plugin","hook","default","item","i","list","indexOf"],"mappings":"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","sourcesContent":["import path from \"path\";\nimport { createHash } from \"crypto\";\nimport * as t from \"../babel-types\";\nimport { getLoc, getTemplateId } from \"@marko/babel-utils\";\nimport { visitors } from \"@babel/traverse\";\nimport { buildLookup } from \"../taglib\";\nimport { parseMarko } from \"./parser\";\nimport { visitor as migrate } from \"./plugins/migrate\";\nimport { visitor as transform } from \"./plugins/transform\";\nimport { MarkoFile } from \"./file\";\nimport { curFS, setFS } from \"../taglib/fs\";\nimport tryLoadTranslator from \"../util/try-load-translator\";\nimport shouldOptimize from \"../util/should-optimize\";\n\nconst SOURCE_FILES = new WeakMap();\n\nexport default (api, markoOpts) => {\n  api.assertVersion(7);\n  const translator = (markoOpts.translator = tryLoadTranslator(\n    markoOpts.translator\n  ));\n  markoOpts.output = markoOpts.output || \"html\";\n\n  if (markoOpts.optimize === undefined) {\n    api.cache.using(shouldOptimize);\n    markoOpts.optimize = shouldOptimize();\n  }\n\n  if (!translator || !translator.translate) {\n    throw new Error(\n      \"@marko/compiler: translator must provide a translate visitor object\"\n    );\n  }\n\n  if (\n    markoOpts.output === \"hydrate\" &&\n    typeof markoOpts.resolveVirtualDependency !== \"function\"\n  ) {\n    throw new Error(\n      `@marko/compiler: the \"resolveVirtualDependency\" option must be supplied when output is \"hydrate\".`\n    );\n  }\n\n  let curOpts;\n\n  return {\n    name: \"marko\",\n    manipulateOptions(opts) {\n      curOpts = opts;\n    },\n    parserOverride(code) {\n      let prevFS = curFS;\n      setFS(markoOpts.fileSystem);\n      try {\n        const file = getMarkoFile(code, curOpts, markoOpts);\n        const finalAst = t.cloneNode(file.ast, true);\n        SOURCE_FILES.set(finalAst, file);\n        return finalAst;\n      } finally {\n        setFS(prevFS);\n      }\n    },\n    pre(file) {\n      let prevFS = curFS;\n      curOpts = undefined;\n      setFS(markoOpts.fileSystem);\n      try {\n        if (markoOpts.output === \"source\" || markoOpts.output === \"migrate\") {\n          return file;\n        }\n\n        const { ast, metadata } = file;\n        const sourceFile = SOURCE_FILES.get(ast);\n        const taglibLookup = sourceFile.___taglibLookup;\n        const rootTranslators = [];\n        const { buildCodeFrameError } = file;\n        const { buildError } = file.hub;\n        metadata.marko = shallowClone(sourceFile.metadata.marko);\n        file.buildCodeFrameError = MarkoFile.prototype.buildCodeFrameError;\n        file.hub.buildError = file.buildCodeFrameError.bind(file);\n        file.markoOpts = markoOpts;\n        file.___taglibLookup = taglibLookup;\n        file.___getMarkoFile = getMarkoFile;\n\n        if (markoOpts.output !== \"hydrate\") {\n          for (const id in taglibLookup.taglibsById) {\n            addPlugin(\n              metadata.marko,\n              rootTranslators,\n              taglibLookup.taglibsById[id].translator\n            );\n          }\n        }\n\n        rootTranslators.push(translator.translate);\n        traverseAll(file, rootTranslators);\n        file.buildCodeFrameError = buildCodeFrameError;\n        file.hub.buildError = buildError;\n        file.markoOpts =\n          file.___taglibLookup =\n          file.___getMarkoFile =\n            undefined;\n\n        metadata.marko.watchFiles = metadata.marko.watchFiles.filter(unique);\n      } finally {\n        setFS(prevFS);\n      }\n    }\n  };\n};\n\nexport function getMarkoFile(code, fileOpts, markoOpts) {\n  const { translator } = markoOpts;\n  let compileCache = markoOpts.cache.get(translator);\n\n  if (!compileCache) {\n    markoOpts.cache.set(translator, (compileCache = new Map()));\n  }\n\n  const { filename } = fileOpts;\n  const isSource = markoOpts.output === \"source\";\n  const isMigrate = markoOpts.output === \"migrate\";\n  const canCache = !(isSource || isMigrate);\n  const id = getTemplateId(markoOpts.optimize, filename);\n  const contentHash = canCache && createHash(\"MD5\").update(code).digest(\"hex\");\n  const cacheKey = canCache && createHash(\"MD5\").update(id).digest(\"hex\");\n\n  let cached = canCache && compileCache.get(cacheKey);\n\n  if (cached) {\n    if (cached.contentHash !== contentHash) {\n      // File content changed, invalidate the cache.\n      cached = undefined;\n    } else {\n      for (const watchFile of cached.file.metadata.marko.watchFiles) {\n        let mtime = Infinity;\n        try {\n          mtime = markoOpts.fileSystem.statSync(watchFile).mtime;\n          // eslint-disable-next-line no-empty\n        } catch {}\n\n        if (mtime > cached.time) {\n          // Some dependency changed, invalidate the cache.\n          cached = undefined;\n          break;\n        }\n      }\n    }\n  }\n\n  if (cached) {\n    return cached.file;\n  }\n\n  const taglibLookup = buildLookup(path.dirname(filename), translator);\n\n  const file = new MarkoFile(fileOpts, {\n    code,\n    ast: {\n      type: \"File\",\n      program: {\n        type: \"Program\",\n        sourceType: \"module\",\n        body: [],\n        directives: []\n      }\n    }\n  });\n\n  const meta = (file.metadata.marko = {\n    id,\n    macros: {},\n    deps: [],\n    tags: [],\n    watchFiles: []\n  });\n\n  file.markoOpts = markoOpts;\n  file.___taglibLookup = taglibLookup;\n  file.___getMarkoFile = getMarkoFile;\n\n  file.ast.start = file.ast.program.start = 0;\n  file.ast.end = file.ast.program.end = code.length - 1;\n  file.ast.loc = file.ast.program.loc = {\n    start: { line: 0, column: 0 },\n    end: getLoc(file, file.ast.end)\n  };\n\n  parseMarko(file);\n\n  if (isSource) {\n    return file;\n  }\n\n  file.path.scope.crawl(); // Initialize bindings.\n\n  const rootMigrators = [];\n  for (const id in taglibLookup.taglibsById) {\n    for (const migrator of taglibLookup.taglibsById[id].migrators) {\n      addPlugin(meta, rootMigrators, migrator);\n    }\n  }\n\n  rootMigrators.push(migrate);\n  traverseAll(file, rootMigrators);\n\n  if (isMigrate) {\n    return file;\n  }\n\n  const rootTransformers = [];\n  for (const id in taglibLookup.taglibsById) {\n    for (const transformer of taglibLookup.taglibsById[id].transformers) {\n      addPlugin(meta, rootTransformers, transformer);\n    }\n  }\n\n  rootTransformers.push(transform);\n  traverseAll(file, rootTransformers);\n\n  for (const taglibId in taglibLookup.taglibsById) {\n    const { filePath } = taglibLookup.taglibsById[taglibId];\n\n    if (\n      filePath[filePath.length - 5] === \".\" &&\n      filePath.endsWith(\"marko.json\")\n    ) {\n      meta.watchFiles.push(filePath);\n    }\n  }\n\n  if (translator.analyze) {\n    traverseAll(file, translator.analyze);\n  }\n\n  compileCache.set(cacheKey, {\n    time: Date.now(),\n    file,\n    contentHash\n  });\n\n  return file;\n}\n\nfunction shallowClone(data) {\n  const clone = {};\n\n  for (const key in data) {\n    const v = data[key];\n\n    if (v !== undefined) {\n      if (v === null || typeof v !== \"object\") {\n        clone[key] = v;\n      } else {\n        const Ctor = v.constructor;\n\n        switch (Ctor) {\n          case Array:\n            clone[key] = [...v];\n            break;\n          case Object:\n          case null:\n            clone[key] = { ...v };\n            break;\n          case Map:\n          case Set:\n          case Date:\n          case RegExp:\n            clone[key] = new Ctor(v);\n            break;\n\n          default:\n            throw new Error(`Unsupported metadata type of ${Ctor.name}`);\n        }\n      }\n    }\n  }\n\n  return clone;\n}\n\nfunction mergeVisitors(all) {\n  if (Array.isArray(all)) {\n    if (all.length === 1) {\n      all = all[0];\n    } else {\n      return visitors.merge(all);\n    }\n  }\n\n  return visitors.explode(all);\n}\n\nfunction traverseAll(file, visitors) {\n  const program = file.path;\n  const { Program, ...mergedVisitors } = mergeVisitors(visitors);\n  program.state = {};\n\n  // Traverse only walks into children by default\n  // This manually traverses into the Program node as well.\n  if (!(Program && Program.enter && program._call(Program.enter))) {\n    program.traverse(mergedVisitors, program.state);\n\n    if (Program && Program.exit) {\n      program._call(Program.exit);\n    }\n  }\n}\n\nfunction addPlugin(meta, arr, plugin) {\n  if (plugin) {\n    const hook = plugin.hook.default || plugin.hook;\n\n    if (plugin.path) {\n      meta.watchFiles.push(plugin.path);\n    }\n\n    if (Array.isArray(hook)) {\n      arr.push(...hook);\n    } else {\n      arr.push(hook);\n    }\n  }\n}\n\nfunction unique(item, i, list) {\n  return list.indexOf(item) === i;\n}\n"],"file":"index.js"}