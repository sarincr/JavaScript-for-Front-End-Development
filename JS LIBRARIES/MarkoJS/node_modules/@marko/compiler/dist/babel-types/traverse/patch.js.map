{"version":3,"sources":["../../../src/babel-types/traverse/patch.js"],"names":["MARKO_TYPES","forEach","typeName","checkKey","assertKey","checkFn","t","assertFn","NodePath","prototype","opts","node","MARKO_ALIAS_TYPES","aliasName","originalProtoCheck","is","call","originalCrawl","Scope","crawl","patchedVisitors","WeakSet","path","originalTraverse","traverse","visitor","state","has","add","Object","assign","explode","MarkoTagBody","body","param","get","scope","registerBinding","MarkoTag","tag","tagVar","name","getBindingIdentifiers","curScope","binding","getBinding","parent","hoistableTagVars","existingBinding","references","length","movedBindings","Map","ref","hasBinding","hoistableBinding","buildCodeFrameError","movedBinding","getScopeDepth","set","moveBindingTo","identifier","depth","cur"],"mappings":"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","sourcesContent":["import \"../types/patch\";\n\nimport * as t from \"@babel/types\";\nimport traverse, { NodePath, Scope } from \"@babel/traverse\";\nimport { MARKO_TYPES, MARKO_ALIAS_TYPES } from \"../types/definitions\";\n\nMARKO_TYPES.forEach(typeName => {\n  const checkKey = `is${typeName}`;\n  const assertKey = `assert${typeName}`;\n  const checkFn = t[checkKey];\n  const assertFn = t[assertKey];\n  NodePath.prototype[checkKey] = function (opts) {\n    return checkFn(this.node, opts);\n  };\n  NodePath.prototype[assertKey] = function (opts) {\n    assertFn(this.node, opts);\n  };\n});\n\nMARKO_ALIAS_TYPES.forEach(aliasName => {\n  const checkKey = `is${aliasName}`;\n  const originalProtoCheck = NodePath.prototype[checkKey];\n  NodePath.prototype[checkKey] = function (opts) {\n    return (\n      t.is(aliasName, this.node, opts) ||\n      originalProtoCheck.call(this, this.node, opts)\n    );\n  };\n});\n\n// Adds a one time patch to the scope collector visitors to include\n// Marko bindings for params and tag vars.\nconst originalCrawl = Scope.prototype.crawl;\nconst patchedVisitors = new WeakSet();\n\nScope.prototype.crawl = function () {\n  const path = this.path;\n  const originalTraverse = path.traverse;\n  path.traverse = function (visitor, state) {\n    path.traverse = originalTraverse;\n\n    if (!patchedVisitors.has(visitor)) {\n      patchedVisitors.add(visitor);\n      Object.assign(\n        traverse.explode(visitor),\n        traverse.explode({\n          MarkoTagBody(body) {\n            for (const param of body.get(\"params\")) {\n              body.scope.registerBinding(\"param\", param);\n            }\n          },\n          MarkoTag(tag) {\n            const tagVar = tag.get(\"var\");\n            if (tagVar.node) {\n              tag.scope.registerBinding(\"local\", tagVar, tag);\n              for (const name in tagVar.getBindingIdentifiers()) {\n                let curScope = tag.scope;\n                const binding = curScope.getBinding(name);\n\n                while ((curScope = curScope.parent)) {\n                  curScope.hoistableTagVars =\n                    curScope.hoistableTagVars ||\n                    (curScope.hoistableTagVars = {});\n                  const existingBinding = curScope.hoistableTagVars[name];\n\n                  if (existingBinding) {\n                    if (existingBinding !== binding) {\n                      curScope.hoistableTagVars[name] = true;\n                    }\n                  } else {\n                    curScope.hoistableTagVars[name] = binding;\n                  }\n                }\n              }\n            }\n          }\n        })\n      );\n    }\n\n    this.traverse(visitor, state);\n\n    if (state.references.length) {\n      const movedBindings = new Map();\n      for (const ref of state.references) {\n        const { name } = ref.node;\n        let curScope = ref.scope;\n        if (curScope.hasBinding(name)) continue;\n\n        do {\n          const hoistableBinding =\n            curScope.hoistableTagVars && curScope.hoistableTagVars[name];\n          if (hoistableBinding) {\n            if (hoistableBinding === true) {\n              throw ref.buildCodeFrameError(\n                \"Ambiguous reference, variable was defined in multiple places and was not shadowed.\"\n              );\n            }\n\n            const movedBinding = movedBindings.get(hoistableBinding);\n            if (\n              !movedBinding ||\n              getScopeDepth(movedBinding) < getScopeDepth(curScope)\n            ) {\n              movedBindings.set(hoistableBinding, curScope);\n            }\n          }\n        } while ((curScope = curScope.parent));\n      }\n\n      for (const [binding, scope] of movedBindings) {\n        binding.scope.moveBindingTo(binding.identifier.name, scope);\n      }\n    }\n  };\n\n  originalCrawl.call(this);\n  path.traverse = originalTraverse;\n};\n\nfunction getScopeDepth(scope) {\n  let depth = 0;\n  let cur = scope;\n  while ((cur = cur.parent)) depth++;\n  return depth;\n}\n"],"file":"patch.js"}