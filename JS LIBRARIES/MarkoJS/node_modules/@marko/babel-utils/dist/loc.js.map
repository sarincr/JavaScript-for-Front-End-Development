{"version":3,"sources":["../src/loc.js"],"names":["LINE_POS_KEY","Symbol","getLoc","file","pos","findLoc","getLinePositions","getLocRange","start","end","linePositions","startLoc","endLoc","line","withLoc","node","loc","metadata","marko","i","code","length","push","startLine","endLine","max","mid","linePos","column"],"mappings":"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","sourcesContent":["const LINE_POS_KEY = Symbol();\n\nexport function getLoc(file, pos) {\n  return findLoc(getLinePositions(file), 0, pos);\n}\n\nexport function getLocRange(file, start, end) {\n  const linePositions = getLinePositions(file);\n  const startLoc = findLoc(linePositions, 0, start);\n\n  if (startLoc) {\n    const endLoc =\n      start === end ? startLoc : findLoc(linePositions, startLoc.line - 1, end);\n\n    return {\n      start: startLoc,\n      end: endLoc\n    };\n  }\n}\n\nexport function withLoc(file, node, start, end) {\n  node.loc = getLocRange(file, start, end);\n  node.start = start;\n  node.end = end;\n  return node;\n}\n\nfunction getLinePositions(file) {\n  let linePositions = file.metadata.marko[LINE_POS_KEY];\n\n  if (!linePositions) {\n    linePositions = [0];\n    for (let i = 0; i < file.code.length; i++) {\n      if (file.code[i] === \"\\n\") {\n        linePositions.push(i);\n      }\n    }\n\n    file.metadata.marko[LINE_POS_KEY] = linePositions;\n  }\n\n  return linePositions;\n}\n\nfunction findLoc(linePositions, startLine, pos) {\n  const endLine = linePositions.length - 1;\n  let max = endLine;\n  let line = startLine;\n\n  while (line < max) {\n    const mid = (line + max) >>> 1;\n    if (linePositions[mid] < pos) {\n      line = mid + 1;\n    } else {\n      max = mid;\n    }\n  }\n\n  let linePos = linePositions[line];\n  if (linePos > pos) {\n    linePos = linePositions[--line];\n  }\n\n  return {\n    line: line + 1,\n    column: pos === linePos ? 0 : pos - linePos - (line === 0 ? 0 : 1)\n  };\n}\n"],"file":"loc.js"}